<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visão 5W2H | Gestão Final</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- VARIÁVEIS E BASE --- */
        :root {
            --primary: #0f4c81;
            --primary-dark: #0a355c;
            --primary-soft: #e6f0fa;
            --bg-body: #f8fafc;
            --white: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --border-light: #e2e8f0;
            --danger: #ef4444;
            --warning: #f59e0b;
            --status-done: #059669;
            --status-done-bg: #d1fae5;
            --status-todo: #475569;
            --status-todo-bg: #f8fafc;
            --brand-cyan: #00d2d3;
            --prio-low: #3b82f6;
            --prio-med: #f59e0b;
            --prio-high: #ef4444;
            
            /* Z-INDEX SCALE */
            --z-back: 1;
            --z-card: 10;
            --z-header: 50;
            --z-overlay: 100;
            --z-modal: 150;
            --z-dropdown: 200;
            --z-toast: 1000;
            --z-loader: 2000;
        }
        
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='rgba(15, 76, 129, 0.05)' fill-opacity='1' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,160C960,139,1056,149,1152,165.3C1248,181,1344,203,1392,213.3L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3Cpath fill='rgba(0, 210, 211, 0.4)' fill-opacity='1' d='M0,256L48,245.3C96,235,192,213,288,192C384,171,480,149,576,165.3C672,181,768,235,864,250.7C960,267,1056,245,1152,229.3C1248,213,1344,203,1392,197.3L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: bottom center;
            background-size: 100% auto;
            background-attachment: fixed;
            margin: 0;
            padding-bottom: 80px;
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        /* --- UI ELEMENTS (TOAST & LOADER) --- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.4s, transform 0.4s;
        }
        
        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success { background: #059669; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #0f4c81; }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.96);
            backdrop-filter: blur(8px);
            z-index: var(--z-loader);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s, visibility 0.5s;
            pointer-events: all;
        }
        
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
        
        .loader-brand-icon {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1;
            background: linear-gradient(135deg, #0f4c81 20%, #00d2d3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(0, 210, 211, 0.3));
            animation: brandPulseSpin 1.8s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55);
            margin-bottom: 20px;
            user-select: none;
        }
        
        .loader-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--primary);
            animation: textFade 1.8s infinite ease-in-out;
        }
        
        @keyframes brandPulseSpin {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 30px rgba(0, 210, 211, 0.6)); }
            100% { transform: scale(1); }
        }
        
        @keyframes textFade {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* --- HEADER & NAVIGATION --- */
        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        .logo-area {
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
        }
        
        .logo-area:hover {
            transform: scale(1.05);
        }
        
        .logo-area h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary);
        }
        
        .brand-text {
            background: linear-gradient(to right, #0f4c81 20%, #00d2d3 50%, #0f4c81 80%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shineText 5s linear infinite;
        }
        
        @keyframes shineText {
            to { background-position: 200% center; }
        }
        
        .logo-svg-clean {
            margin-right: 6px;
            filter: drop-shadow(0 4px 6px rgba(15, 76, 129, 0.1));
            transition: transform 0.4s ease;
            transform: rotate(-15deg) translateY(-6px);
        }
        
        .logo-area:hover .logo-svg-clean {
            transform: rotate(-15deg) translateY(-10px) scale(1.1);
            filter: drop-shadow(0 8px 15px rgba(0, 210, 211, 0.3));
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* SEARCH BOX */
        .search-wrapper {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
        }
        
        .search-input {
            width: 40px;
            height: 40px;
            border-radius: 50px;
            border: 1px solid transparent;
            background: transparent;
            padding: 0 10px 0 40px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: width 0.4s, background 0.4s, opacity 0.4s;
            opacity: 0;
            position: relative;
            z-index: 2;
        }
        
        .search-icon-bg {
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            pointer-events: none;
            transition: 0.3s;
        }
        
        .search-wrapper:hover .search-input,
        .search-input:focus,
        .search-input:not(:placeholder-shown) {
            width: 220px;
            background: white;
            border-color: var(--border-light);
            opacity: 1;
            cursor: text;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        /* HEADER BUTTONS */
        .btn-toggle-stats {
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--border-light);
            padding: 9px 15px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s, color 0.2s;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .btn-toggle-stats:hover,
        .btn-toggle-stats.active {
            background: var(--primary-soft);
            color: var(--primary);
            border-color: var(--primary-soft);
        }
        
        .btn-main-add {
            background: linear-gradient(135deg, #0f4c81 0%, #00d2d3 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            box-shadow: 0 4px 12px rgba(15, 76, 129, 0.25);
        }
        
        .btn-main-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 210, 211, 0.4);
        }
        
        .btn-main-add span {
            transition: transform 0.4s ease;
        }
        
        .btn-main-add:hover span {
            transform: rotate(90deg) scale(1.1);
        }
        
        /* --- BARRA DE FILTROS --- */
        .filter-container {
            width: fit-content;
            max-width: 100%;
            margin: 25px auto 0 auto;
            padding: 12px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.02);
            position: relative;
            z-index: 40;
        }
        
        .custom-dropdown {
            position: relative;
            min-width: 220px;
            flex: 1;
            font-family: 'Inter', sans-serif;
        }
        
        .dropdown-btn {
            background: white;
            border-radius: 50px;
            padding: 10px 16px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
            height: 44px;
            user-select: none;
        }
        
        .dropdown-btn:hover,
        .custom-dropdown.active .dropdown-btn {
            border-color: var(--brand-cyan);
            box-shadow: 0 4px 12px rgba(0, 210, 211, 0.15);
            transform: translateY(-1px);
        }
        
        .btn-content {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
            font-weight: 600;
            font-size: 0.85rem;
            overflow: hidden;
            flex: 1;
        }
        
        .btn-content .label-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 100%;
        }
        
        .btn-icon { color: var(--primary); font-size: 20px; flex-shrink: 0; }
        .arrow-icon { color: var(--text-light); font-size: 20px; transition: transform 0.3s ease; flex-shrink: 0; }
        
        .custom-dropdown.active .arrow-icon {
            transform: rotate(180deg);
            color: var(--brand-cyan);
        }
        
        .dropdown-options {
            position: absolute;
            top: 115%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-light);
            padding: 5px;
            z-index: var(--z-toast);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.165, 0.84, 0.44, 1);
            max-height: 250px;
            overflow-y: auto;
        }
        
        .dropdown-options::-webkit-scrollbar { width: 6px; }
        .dropdown-options::-webkit-scrollbar-track { background: transparent; }
        .dropdown-options::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        
        .custom-dropdown.active .dropdown-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-main);
            transition: 0.1s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dropdown-item:hover {
            background-color: var(--primary-soft);
            color: var(--primary);
        }
        
        .dropdown-item.selected {
            background-color: #f0f9ff;
            color: var(--primary);
            font-weight: 700;
        }
        
        .dropdown-item.selected::after {
            content: 'check';
            font-family: 'Material Icons Round';
            font-size: 16px;
            color: var(--brand-cyan);
        }
        
        .btn-clear-filters {
            font-size: 0.8rem;
            color: var(--danger);
            font-weight: 700;
            cursor: pointer;
            border: none;
            background: rgba(239, 68, 68, 0.08);
            border-radius: 50px;
            white-space: nowrap;
            overflow: hidden;
            max-width: 0;
            padding: 0 0;
            opacity: 0;
            margin-left: 0;
            pointer-events: none;
            transition: all 0.45s cubic-bezier(0.19, 1, 0.22, 1);
        }
        
        .btn-clear-filters.visible {
            max-width: 150px;
            padding: 8px 16px;
            opacity: 1;
            margin-left: auto;
            pointer-events: auto;
        }
        
        .btn-clear-filters:hover {
            background: rgba(239, 68, 68, 0.15);
            transform: scale(1.05);
        }
        
        .click-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 30;
            display: none;
            cursor: default;
        }
        
        .click-overlay.active { display: block; }
        
        /* --- DASHBOARD / ESTATÍSTICAS --- */
        .stats-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fff;
            border-bottom: 1px solid transparent;
        }
        
        .stats-panel.open {
            max-height: 1000px;
            border-bottom-color: var(--border-light);
        }
        
        .dashboard-grid {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        .chart-box {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            max-height: 400px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }
        
        .span-2 { grid-column: span 2; }
        .span-4 { grid-column: 1 / -1; }
        
        .chart-container-fixed {
            position: relative;
            height: 200px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .chart-scroll-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            padding-right: 10px;
        }
        
        .chart-dynamic-height {
            position: relative;
            width: 100%;
        }
        
        .chart-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* --- GRID PRINCIPAL E CARDS --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            min-height: 300px;
            align-items: start;
            transition: opacity 0.25s ease; /* Removido transform para evitar lag */
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 20px;
            color: var(--text-light);
            animation: fadeInUpStaggered 0.5s ease;
        }
        
        @keyframes fadeInUpStaggered {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 0;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            overflow: visible; /* Importante para o PIN */
            transform: translateZ(0); /* Aceleração de hardware */
            backface-visibility: hidden;
            will-change: transform, box-shadow; /* Otimização de renderização */
            z-index: var(--z-card);
        }
        
        .card.animate-in {
            animation: fadeInUpStaggered 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) backwards;
        }
        
        .card:hover {
            transform: translateY(-5px) scale(1.01) translateZ(0);
            box-shadow: 0 20px 25px -5px rgba(15, 76, 129, 0.1), 0 10px 10px -5px rgba(15, 76, 129, 0.04);
            border-color: rgba(15, 76, 129, 0.25);
            z-index: 15;
        }
        
        .card.is-late { background: #fff5f5; border: 1px solid #fecaca; }
        .card.is-late:hover { border-color: #fca5a5; }
        
        .card.is-concluded { background: #f0fdf4; border: 1px solid #dcfce7; opacity: 0.8; filter: grayscale(100%); }
        .card.is-concluded:hover { opacity: 1; filter: grayscale(0%); border-color: var(--status-done); }
        
        .card-main {
            padding: 20px 24px 15px 24px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .card-footer {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.5);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: auto;
        }
        
        .card-progress-bar {
            height: 4px;
            width: 100%;
            background: rgba(0, 0, 0, 0.05);
        }
        
        .progress-fill {
            height: 100%;
            width: 100%;
            transition: width 1s ease;
        }
        
        .card-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-right: 20px; /* Espaço para o Pin */
        }
        
        .prio-badge {
            font-size: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: 6px;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .p-alta { background: var(--prio-high); }
        .p-media { background: var(--prio-med); }
        .p-baixa { background: var(--prio-low); }
        
        .status-text {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.3px;
        }
        
        .dot-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
        }
        
        .st-pendente .dot-status { background: var(--status-todo); }
        .st-andamento .dot-status { background: var(--warning); }
        .st-concluido .dot-status { background: var(--status-done); }
        
        .card h3 {
            margin: 0 0 8px 0;
            font-size: 1.05rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
            letter-spacing: -0.3px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
        }
        
        .card-origin-row {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            background: rgba(0, 0, 0, 0.04);
            padding: 4px 10px;
            border-radius: 6px;
            width: fit-content;
            max-width: 100%;
            letter-spacing: 0.2px;
        }
        
        .card-icon-std { font-size: 16px; color: inherit; }
        
        .card-thumbs {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .thumb-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #e2e8f0;
            color: var(--primary);
            text-decoration: none;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        
        .thumb-link:hover {
            background: var(--brand-cyan);
            color: white;
            border-color: var(--brand-cyan);
            transform: translateY(-2px);
        }
        
        .thumb-more {
            font-size: 0.65rem;
            color: var(--text-light);
            font-weight: 700;
            background: #f1f5f9;
            padding: 0 8px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        
        .card-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: #475569;
            font-weight: 600;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .meta-item { display: flex; align-items: center; gap: 6px; }
        
        .date-pill {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 800;
            margin-left: 4px;
            letter-spacing: 0.5px;
        }
        
        .date-pill.late { background: #fee2e2; color: #b91c1c; border: none; }
        .date-pill.ontime { background: #dcfce7; color: #15803d; border: none; }
        .date-pill.nodate { background: #f1f5f9; color: #94a3b8; border: none; }
        
        /* --- PINNED CONTAINER / EM OBSERVAÇÃO --- */
        .pinned-container {
            max-width: 1200px;
            margin: 20px auto 0 auto;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px dashed var(--brand-cyan);
            display: none;
            flex-direction: column;
            gap: 10px;
        }
        
        .pinned-container.visible {
            display: flex;
            animation: slideInPinned 0.5s ease;
        }
        
        @keyframes slideInPinned {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pinned-title {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .pinned-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 5px 15px 5px;
            scrollbar-width: thin;
            scroll-behavior: smooth;
        }
        
        .pinned-grid::-webkit-scrollbar { height: 6px; }
        .pinned-grid::-webkit-scrollbar-track { background: transparent; }
        .pinned-grid::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        
        .pinned-card {
            min-width: 250px;
            max-width: 250px;
            background: white;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            margin: 2px;
            transform: translateZ(0);
            will-change: transform, opacity; /* Otimização vital */
        }
        
        .pinned-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px rgba(0, 210, 211, 0.15);
            border-color: var(--brand-cyan);
            z-index: 10;
        }
        
        /* ANIMAÇÃO DE ENTRADA DO PIN */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .pinned-card.animate-enter {
            animation: fadeInScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ANIMAÇÃO DE SAÍDA DO PIN */
        .pinned-card.animate-leave {
            animation: fadeOutScale 0.3s forwards;
            pointer-events: none;
        }
        @keyframes fadeOutScale {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
        
        /* BOTÃO DE PIN DISCRETO (NO CARD) */
        .btn-pin-card {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: #cbd5e1; /* Cinza claro inativo */
            cursor: pointer;
            z-index: 20;
            transition: 0.2s;
            will-change: transform, color;
        }
        
        .btn-pin-card:hover {
            background: var(--primary-soft);
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .btn-pin-card.active {
            color: var(--brand-cyan);
            opacity: 1;
        }

        /* --- AVATARES --- */
        .resp-container {
            display: flex;
            align-items: center;
            padding-left: 10px;
            height: 50px;
        }
        
        .avatar-stack-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 800;
            border: 3px solid white;
            margin-left: -20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            text-transform: uppercase;
            position: relative;
            transition: transform 0.2s, z-index 0.2s;
            background-color: #cbd5e1;
            overflow: hidden;
            cursor: help;
            flex-shrink: 0;
        }
        
        .avatar-stack-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-stack-item:hover {
            transform: translateY(-6px) scale(1.15);
            z-index: 50;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
            border-color: var(--primary-soft);
        }
        
        .av-color-0 { background: #3b82f6; }
        .av-color-1 { background: #ef4444; }
        .av-color-2 { background: #10b981; }
        .av-color-3 { background: #f59e0b; }
        .av-color-4 { background: #8b5cf6; }
        .av-color-5 { background: #ec4899; }
        
        .unit-clean {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            opacity: 0.9;
            letter-spacing: 0.5px;
            margin-left: auto;
        }
        
        /* --- MODAL E FORMS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(5px);
            z-index: var(--z-overlay);
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.active { opacity: 1; }
        
        .modal-wide {
            background: white;
            width: 1100px;
            max-width: 95%;
            height: 90vh;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            opacity: 0;
            transform: translateY(100px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal-overlay.active .modal-wide {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        .modal-top {
            padding: 25px 40px 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #fff;
            gap: 20px;
            position: relative;
        }
        
        .modified-field {
            border: 1px solid #f97316 !important;
            background-color: #fff7ed !important;
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15) !important;
            transition: all 0.3s ease;
        }
        
        .field-group, .modern-date-wrapper { position: relative; }
        
        .title-textarea {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            border: none;
            font-weight: 900;
            color: var(--primary-dark);
            width: 100%;
            background: transparent;
            padding: 5px 0;
            line-height: 1.2;
            outline: none;
            resize: none;
            overflow: hidden;
            height: auto;
            min-height: 50px;
            margin-top: 5px;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }
        
        .title-textarea:focus { border-bottom: 2px solid var(--brand-cyan); }
        .title-textarea::placeholder { color: #cbd5e0; font-weight: 700; opacity: 0.6; }
        
        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: #f1f5f9;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            color: var(--text-light);
            border: none;
            flex-shrink: 0;
        }
        
        .close-btn:hover {
            background: var(--brand-cyan);
            color: white;
            transform: rotate(90deg);
        }
        
        .modal-body-dashboard {
            flex: 1;
            overflow-y: auto;
            background: #f8fafc;
            padding: 0 40px 30px 40px;
            display: grid;
            grid-template-columns: 3fr 2fr;
            grid-template-rows: auto auto 1fr;
            gap: 25px;
            scroll-behavior: smooth;
        }
        
        .context-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px 0 20px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        
        .field-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-light);
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .std-input-base, .modern-date-wrapper {
            width: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.01);
            appearance: none;
            outline: none;
        }
        
        .modern-date-wrapper {
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
        }
        
        .std-input-base:hover, .modern-date-wrapper:hover {
            border-color: var(--primary-soft);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .std-input-base:focus, .modern-date-wrapper:focus-within {
            border-color: var(--brand-cyan);
            box-shadow: 0 0 0 3px rgba(0, 210, 211, 0.1);
        }
        
        .std-textarea { resize: vertical; min-height: 80px; line-height: 1.5; padding: 15px; }
        .textarea-tall { min-height: 120px; }
        .textarea-xl { min-height: 150px; }
        
        .custom-dropdown-modal {
            position: relative;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }
        
        .modal-dropdown-btn {
            width: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.01);
            user-select: none;
        }
        
        .modal-dropdown-btn:hover,
        .custom-dropdown-modal.active .modal-dropdown-btn {
            border-color: var(--brand-cyan);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .modal-dropdown-options {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-light);
            padding: 5px;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.165, 0.84, 0.44, 1);
            max-height: 200px;
            overflow-y: auto;
        }
        
        .custom-dropdown-modal.active .modal-dropdown-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .modal-dropdown-options .dropdown-item.selected {
            background-color: #f0f9ff;
            color: var(--primary);
            font-weight: 700;
        }
        
        .modal-dropdown-options .dropdown-item.selected::after {
            content: 'check';
            font-family: 'Material Icons Round';
            font-size: 16px;
            color: var(--brand-cyan);
            margin-left: auto;
        }
        
        /* --- AJUSTES DE ESPAÇAMENTO --- */
        .clean-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.01);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .plan-column, .exec-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .section-header {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header-resp {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 5px;
        }
        
        .resp-area-clean {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 10px;
            background: transparent;
            padding: 0;
            border: none;
            box-shadow: none;
        }
        
        .modern-date-label {
            font-size: 0.65rem;
            font-weight: 800;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .modern-date-input {
            border: none;
            background: transparent;
            width: 100%;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-main);
            outline: none;
            padding: 0;
            cursor: pointer;
        }
        
        .dates-row-clean {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        #modalAvatarList {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0;
            row-gap: 30px;
            min-height: 100px;
            align-items: center;
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
            transition: padding-right 0.4s ease, padding-left 0.4s ease;
        }
        
        .avatar-wrapper {
            position: relative;
            z-index: 1;
            margin: 0 0 5px -15px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            box-shadow: -5px 0 10px rgba(0, 0, 0, 0.05);
            opacity: 1;
            transform: scale(1);
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), z-index 0s;
        }
        
        .avatar-wrapper:first-child { margin-left: 0; }
        
        .avatar-wrapper:hover {
            transform: translateY(-12px) scale(1.25) !important;
            z-index: 500;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes avatarSmoothAppear {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .avatar-wrapper.animate-in {
            animation: avatarSmoothAppear 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }
        
        .modal-avatar-big {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            aspect-ratio: 1/1;
            overflow: hidden;
            border: 4px solid white;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            text-transform: uppercase;
            background-color: #cbd5e1;
        }
        
        .avatar-wrapper::after {
            content: attr(data-name);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 200;
        }
        
        .avatar-wrapper:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .input-add-resp {
            background: #f1f5f9;
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 12px 15px;
            width: 100%;
            max-width: 100%;
            margin-top: 15px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--text-main);
            transition: all 0.2s, box-shadow 0.2s;
            text-align: center;
            font-weight: 600;
            resize: none;
            min-height: 46px;
            overflow: hidden;
            line-height: 1.4;
        }
        
        .input-add-resp:hover { background: #e2e8f0; }
        .input-add-resp:focus {
            background: #fff;
            border-color: var(--brand-cyan);
            box-shadow: 0 4px 15px rgba(0, 210, 211, 0.15);
        }
        
        .input-add-resp::placeholder { color: #94a3b8; font-weight: 500; }
        
        /* --- MAPA E HISTÓRICO --- */
        .map-timeline {
            position: relative;
            padding: 10px 0 10px 20px;
            display: flex;
            flex-direction: column;
            width: 100%;
            border-left: 2px dashed #cbd5e1;
            margin-left: 10px;
        }
        
        .map-item {
            width: 100%;
            margin-bottom: 25px;
            position: relative;
            padding-left: 30px;
            box-sizing: border-box;
            z-index: 2;
        }
        
        .map-connector {
            position: absolute;
            left: 0;
            top: 28px;
            width: 30px;
            height: 2px;
            background: #cbd5e1;
            z-index: 1;
        }
        
        .map-dot {
            position: absolute;
            left: -8px;
            top: 22px;
            width: 14px;
            height: 14px;
            background: var(--brand-cyan);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 2px var(--brand-cyan);
            z-index: 5;
        }
        
        .map-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            width: 100%;
            cursor: pointer;
            z-index: 10;
            overflow: hidden;
            text-align: left;
        }
        
        .map-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-color: var(--brand-cyan);
        }
        
        .map-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            gap: 15px;
            min-height: 60px;
        }
        
        .map-header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }
        
        .map-title {
            font-weight: 800;
            color: var(--primary);
            font-size: 0.95rem;
            text-transform: uppercase;
            line-height: 1.3;
            word-wrap: break-word;
        }
        
        .map-date {
            font-size: 0.7rem;
            font-weight: 700;
            background: #f1f5f9;
            padding: 3px 10px;
            border-radius: 4px;
            color: var(--text-light);
            width: fit-content;
        }
        
        .map-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .map-btn-icon {
            font-size: 16px;
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-btn-icon:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .map-btn-icon.del:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        .toggle-icon {
            color: var(--text-light);
            font-size: 20px;
            transition: transform 0.3s;
            margin-left: 5px;
            cursor: pointer;
        }
        
        .map-card.open .toggle-icon {
            transform: rotate(180deg);
            color: var(--brand-cyan);
        }
        
        .map-card-body {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
            border-top: 1px solid transparent;
        }
        
        .map-card.open .map-card-body {
            grid-template-rows: 1fr;
            border-top-color: #e2e8f0;
        }
        
        .map-card-content-inner {
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.4s ease 0.1s, transform 0.4s ease 0.1s;
        }
        
        .map-card.open .map-card-content-inner {
            opacity: 1;
            transform: translateY(0);
        }
        
        .map-desc {
            padding: 20px;
            font-size: 0.9rem;
            color: var(--text-main);
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); max-height: 200px; margin-bottom: 25px; }
            to { opacity: 0; transform: translateX(20px); max-height: 0; margin-bottom: 0; padding: 0; border: none; }
        }
        
        .map-item.new-item {
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .map-item.removing {
            animation: slideOutRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
        }
        
        /* OUTROS MODAIS E CONFIRMAÇÕES */
        .name-list-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
        }
        
        .name-list-item:hover {
            background-color: var(--primary-soft);
            color: var(--primary);
        }
        
        .name-list-item:last-child { border-bottom: none; }
        
        .modal-footer {
            padding: 20px 40px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            gap: 20px;
        }
        
        .status-segmented {
            display: flex;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 50px;
            gap: 0;
            border: 1px solid #e2e8f0;
        }
        
        .seg-btn {
            padding: 10px 25px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .seg-btn:hover {
            color: var(--primary);
            background: rgba(255, 255, 255, 0.5);
        }
        
        .seg-btn.active {
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.05);
        }
        
        .seg-btn[data-val="pendente"].active { background: var(--status-todo); }
        .seg-btn[data-val="andamento"].active { background: var(--warning); color: white; }
        .seg-btn[data-val="concluido"].active { background: var(--status-done); }
        
        .btn-save {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 10px 20px -5px rgba(15, 76, 129, 0.4);
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px -5px rgba(15, 76, 129, 0.5);
        }
        
        .btn-save:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #fff;
            transition: 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary);
            background: var(--primary-soft);
        }
        
        .file-input-hidden {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-chip {
            font-size: 0.75rem;
            background: #e2e8f0;
            padding: 5px 8px 5px 12px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            border: 1px solid #cbd5e0;
            max-width: 95%;
            overflow: hidden;
            transition: 0.2s;
        }
        
        .file-name-trunc {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            display: block;
            font-weight: 600;
        }
        
        .file-remove-btn {
            width: 20px;
            height: 20px;
            background: #cbd5e0;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 800;
            font-size: 14px;
            pointer-events: auto;
            z-index: 10;
        }
        
        .file-remove-btn:hover {
            background: var(--danger);
            transform: scale(1.1);
        }
        
        .existing-file-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
            background: #f0f9ff;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #bae6fd;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .existing-file-link:hover {
            background: #e0f2fe;
        }
        
        .file-preview-img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid #cbd5e0;
        }
        
        .btn-add-history {
            margin-top: 10px;
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(15, 76, 129, 0.2);
        }
        
        .btn-add-history:hover {
            background: #155d9b;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(15, 76, 129, 0.4);
        }
        
        .confirm-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: 0.3s;
        }
        
        .modal-overlay.active .confirm-box { transform: scale(1); }
        
        .confirm-icon {
            width: 60px;
            height: 60px;
            background: #fef2f2;
            border-radius: 50%;
            color: var(--danger);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }
        
        .alert-icon {
            width: 60px;
            height: 60px;
            background: #fff7ed;
            border-radius: 50%;
            color: var(--warning);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }
        
        .confirm-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 10px;
        }
        
        .confirm-desc {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-cancel {
            background: #f1f5f9;
            color: var(--text-main);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        
        .btn-delete:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-ok {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        #modalAvatarList:empty { display: none !important; }

        .header-action-icon {
            position: absolute;
            right: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f1f5f9;
            color: var(--primary);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .header-action-icon:hover {
            background: var(--brand-cyan);
            color: white;
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 5px 15px rgba(0, 210, 211, 0.4);
        }
        
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .span-2, .span-4 { grid-column: 1; }
            header { flex-direction: column; padding: 15px; }
            .header-actions { width: 100%; flex-direction: column; gap: 10px; margin-top: 10px; }
            .search-wrapper { width: 100%; }
            .search-input { width: 100%; opacity: 1; background: white; padding-left: 40px; }
            .modal-wide { width: 100%; height: 100%; max-width: 100%; border-radius: 0; }
            .modal-body-dashboard {
                grid-template-columns: 1fr;
                display: flex;
                flex-direction: column;
                padding: 20px;
                overflow-y: auto;
                height: calc(100% - 160px);
            }
            .context-row { grid-template-columns: 1fr 1fr; }
            .modal-top { flex-direction: column; align-items: flex-start; padding: 20px; position: relative; }
            .close-btn { position: absolute; top: 20px; right: 20px; }
            .title-textarea { font-size: 1.4rem; padding-right: 40px; }
            .modal-footer { flex-direction: column; gap: 12px; padding: 20px; height: auto; }
            .status-segmented {
                flex-direction: column;
                width: 100%;
                height: auto;
                border-radius: 16px;
                padding: 8px;
                gap: 5px;
            }
            .seg-btn { width: 100%; justify-content: center; padding: 12px; border-radius: 8px; }
            .btn-save { width: 100%; padding: 15px; font-size: 1rem; }
            .filter-container { flex-direction: column; align-items: stretch; gap: 10px; }
            .custom-dropdown { width: 100%; max-width: none; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>

</head>

<body>

    <div id="toast-container"></div>
    <div class="click-overlay" id="clickOverlay" onclick="closeAllDropdowns()"></div>

    <div id="loading-overlay">
        <div class="loader-brand-icon">5W2H</div>
        <div class="loader-text">Carregando Visão...</div>
    </div>

    <header>
        <div class="logo-area" onclick="resetarPagina()">
            <svg class="logo-svg-clean" width="38" height="26" viewBox="0 0 50 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="brandGrad" x1="0" y1="0" x2="50" y2="0" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#0f4c81"/>
                        <stop offset="1" stop-color="#00d2d3"/>
                    </linearGradient>
                </defs>
                <path d="M18 6 L 25 12 L 32 6" stroke="url(#brandGrad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 19 L 15 25 L 22 19" stroke="url(#brandGrad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M28 19 L 35 25 L 42 19" stroke="url(#brandGrad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1><span class="brand-text">VISÃO 5W2H</span></h1>
        </div>
        <div class="header-actions">
            <div class="search-wrapper"><input type="text" class="search-input" placeholder="Pesquisar..." onkeyup="filtrarCards(this.value)">
                <div class="search-icon-bg"><span class="material-icons-round">search</span></div>
            </div>
            <button class="btn-toggle-stats" onclick="toggleStats(event)" id="btnStats"><span class="material-icons-round">bar_chart</span><span style="font-size:0.9rem">Estatísticas</span></button>
            <button class="btn-main-add" onclick="abrirModal(null, event)"><span class="material-icons-round">add_circle</span></button>
        </div>
    </header>

    <div class="stats-panel" id="statsPanel">
        <div class="dashboard-grid">
            <div class="chart-box">
                <div class="chart-title">Workflow (Geral)</div>
                <div class="chart-container-fixed"><canvas id="chartStatus"></canvas></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Performance de Prazos</div>
                <div class="chart-container-fixed"><canvas id="chartPrazos"></canvas></div>
            </div>
            <div class="chart-box span-2">
                <div class="chart-title">Ocorrências por Unidade</div>
                <div class="chart-container-fixed"><canvas id="chartUnit"></canvas></div>
            </div>
            <div class="chart-box span-4">
                <div class="chart-title">Ranking de Responsáveis (Top 5)</div>
                <div class="chart-scroll-wrapper">
                    <div class="chart-dynamic-height" id="respChartContainer"><canvas id="chartResp"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="filter-container">
        <div class="custom-dropdown" id="dd-status">
            <input type="hidden" id="filtro-status" value="todos">
            <div class="dropdown-btn" onclick="toggleDropdown('dd-status')">
                <div class="btn-content"><span class="material-icons-round btn-icon">view_kanban</span><span class="label-text" id="lbl-status">Status: Todos</span></div>
                <span class="material-icons-round arrow-icon">expand_more</span>
            </div>
            <div class="dropdown-options">
                <div class="dropdown-item selected" onclick="selectFilter('status', 'todos', 'Status: Todos', this)">Status: Todos</div>
                <div class="dropdown-item" onclick="selectFilter('status', 'pendente', 'A Fazer', this)">A Fazer</div>
                <div class="dropdown-item" onclick="selectFilter('status', 'andamento', 'Em Andamento', this)">Em Andamento</div>
                <div class="dropdown-item" onclick="selectFilter('status', 'concluido', 'Concluídos', this)">Concluídos</div>
            </div>
        </div>

        <div class="custom-dropdown" id="dd-prioridade">
            <input type="hidden" id="filtro-prioridade" value="todos">
            <div class="dropdown-btn" onclick="toggleDropdown('dd-prioridade')">
                <div class="btn-content"><span class="material-icons-round btn-icon">flag</span><span class="label-text" id="lbl-prioridade">Prioridade: Todas</span></div>
                <span class="material-icons-round arrow-icon">expand_more</span>
            </div>
            <div class="dropdown-options">
                <div class="dropdown-item selected" onclick="selectFilter('prioridade', 'todos', 'Prioridade: Todas', this)">Prioridade: Todas</div>
                <div class="dropdown-item" onclick="selectFilter('prioridade', 'alta', 'Alta', this)">Alta</div>
                <div class="dropdown-item" onclick="selectFilter('prioridade', 'media', 'Média', this)">Média</div>
                <div class="dropdown-item" onclick="selectFilter('prioridade', 'baixa', 'Baixa', this)">Baixa</div>
            </div>
        </div>

        <div class="custom-dropdown" id="dd-unidade">
            <input type="hidden" id="filtro-unidade" value="todos">
            <div class="dropdown-btn" onclick="toggleDropdown('dd-unidade')">
                <div class="btn-content"><span class="material-icons-round btn-icon">location_on</span><span class="label-text" id="lbl-unidade">Unidade: Todas</span></div>
                <span class="material-icons-round arrow-icon">expand_more</span>
            </div>
            <div class="dropdown-options" id="list-unidade"></div>
        </div>
        <div class="custom-dropdown" id="dd-origem">
            <input type="hidden" id="filtro-origem" value="todos">
            <div class="dropdown-btn" onclick="toggleDropdown('dd-origem')">
                <div class="btn-content"><span class="material-icons-round btn-icon">source</span><span class="label-text" id="lbl-origem">Origem: Todas</span></div>
                <span class="material-icons-round arrow-icon">expand_more</span>
            </div>
            <div class="dropdown-options" id="list-origem"></div>
        </div>
        <button id="btn-limpar" class="btn-clear-filters" onclick="limparFiltros()">Limpar Filtros &times;</button>
    </div>

    <div class="pinned-container" id="pinnedSection">
        <div class="pinned-title">
            <span class="material-icons-round" style="color:var(--brand-cyan)">push_pin</span> 
            Em Observação (24h)
        </div>
        <div class="pinned-grid" id="pinnedGrid"></div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-wide">
            <div class="modal-top">
                <textarea id="inpTitle" class="title-textarea" placeholder="NOME DO PLANO (TÍTULO)" rows="1" oninput="autoResize(this)"></textarea>
                <input type="hidden" id="taskId">
                <button class="close-btn" onclick="fecharModal()"><span class="material-icons-round">close</span></button>
            </div>

            <div class="modal-body-dashboard">

                <div class="context-row">
                    <div class="field-group">
                        <label class="field-label"><span class="material-icons-round" style="font-size:14px">source</span> Origem <span style="color:var(--danger)">*</span></label>
                        <input type="text" id="inpOrigin" class="std-input-base" placeholder="Ex: E-mail">
                    </div>
                    <div class="field-group">
                        <label class="field-label"><span class="material-icons-round" style="font-size:14px">location_on</span> Unidade</label>

                        <div class="custom-dropdown-modal" id="dd-modal-unit" onclick="toggleModalDropdown('dd-modal-unit', event)">
                            <div class="modal-dropdown-btn">
                                <span id="display-unit">Selecionar...</span>
                                <span class="material-icons-round" style="font-size:20px; color:var(--text-light)">expand_more</span>
                            </div>
                            <div class="modal-dropdown-options">
                                <div class="dropdown-item" data-value="N/A" onclick="selectModalOption('unit', 'N/A', 'N/A', event)">N/A</div>
                                <div class="dropdown-item" data-value="Todas" onclick="selectModalOption('unit', 'Todas', 'Todas', event)">Todas</div>
                                <div class="dropdown-item" data-value="CER IV" onclick="selectModalOption('unit', 'CER IV', 'CER IV', event)">CER IV</div>
                                <div class="dropdown-item" data-value="Iputinga" onclick="selectModalOption('unit', 'Iputinga', 'Iputinga', event)">Iputinga</div>
                                <div class="dropdown-item" data-value="Boa Vista" onclick="selectModalOption('unit', 'Boa Vista', 'Boa Vista', event)">Boa Vista</div>
                                <div class="dropdown-item" data-value="Jaboatão" onclick="selectModalOption('unit', 'Jaboatão', 'Jaboatão', event)">Jaboatão</div>
                                <div class="dropdown-item" data-value="Salgueiro" onclick="selectModalOption('unit', 'Salgueiro', 'Salgueiro', event)">Salgueiro</div>
                                <div class="dropdown-item" data-value="Serra Talhada" onclick="selectModalOption('unit', 'Serra Talhada', 'Serra Talhada', event)">Serra Talhada</div>
                                <div class="dropdown-item" data-value="CFAV" onclick="selectModalOption('unit', 'CFAV', 'CFAV', event)">CFAV</div>
                            </div>
                            <input type="hidden" id="inpUnit" value="">
                        </div>

                    </div>
                    <div class="field-group">
                        <label class="field-label"><span class="material-icons-round" style="font-size:14px">flag</span> Priorização</label>

                        <div class="custom-dropdown-modal" id="dd-modal-prio" onclick="toggleModalDropdown('dd-modal-prio', event)">
                            <div class="modal-dropdown-btn">
                                <span id="display-prio">Baixa</span>
                                <span class="material-icons-round" style="font-size:20px; color:var(--text-light)">expand_more</span>
                            </div>
                            <div class="modal-dropdown-options">
                                <div class="dropdown-item" data-value="baixa" onclick="selectModalOption('priority', 'baixa', 'Baixa', event)">Baixa</div>
                                <div class="dropdown-item" data-value="media" onclick="selectModalOption('priority', 'media', 'Média', event)">Média</div>
                                <div class="dropdown-item" data-value="alta" onclick="selectModalOption('priority', 'alta', 'Alta', event)">Alta</div>
                            </div>
                            <input type="hidden" id="inpPriority" value="baixa">
                        </div>

                    </div>
                    <div class="field-group">
                        <label class="field-label"><span class="material-icons-round" style="font-size:14px">attach_money</span> Custo</label>
                        <input type="text" id="inpCost" class="std-input-base" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
                    </div>
                </div>

                <div class="plan-column">
                    <div class="clean-section resp-area-clean">
                        
                        <div class="section-header-resp">
                            <span style="font-family:'Montserrat',sans-serif; font-size:0.85rem; font-weight:800; color:var(--primary); text-transform:uppercase; display:flex; align-items:center; gap:6px;">
                                <span class="material-icons-round" style="font-size:18px">group</span> Quem? (Responsáveis)
                            </span>
                            
                            <button type="button" class="header-action-icon" onclick="abrirModalNomes(event)" title="Consultar Banco de Nomes">
                                <span class="material-icons-round" style="font-size:20px">person_search</span>
                            </button>
                        </div>
                        
                        <div id="modalAvatarList"></div>
                        <textarea id="inpResp" class="input-add-resp" rows="1" placeholder="Digite os nomes (separe por vírgula)..." oninput="autoResize(this); gerenciarInputResponsavel(this)"></textarea>
                    </div>

                    <div class="clean-section">
                        <div class="section-header">Descrição</div>
                        <textarea id="inpProblem" class="std-input-base std-textarea textarea-tall" placeholder="Descreva os detalhes técnicos da demanda..."></textarea>
                    </div>

                    <div class="clean-section">
                        <div class="section-header">Por Quê? (Justificativa)</div>
                        <textarea id="inpWhy" class="std-input-base std-textarea textarea-xl" placeholder="Motivo da ação..."></textarea>
                    </div>

                    <div class="clean-section">
                        <div class="section-header">Como? (Método)</div>
                        <textarea id="inpHow" class="std-input-base std-textarea textarea-xl" placeholder="Plano de ação..."></textarea>
                    </div>
                </div>

                <div class="exec-column">
                    <div class="clean-section">
                        <div class="section-header"><span style="display:flex;align-items:center;gap:6px;"><span class="material-icons-round" style="font-size:18px">event</span> Quando? (Prazos)</span>
                        </div>
                        <div class="dates-row-clean">
                            <div class="modern-date-wrapper" onclick="acionarCalendario(this)">
                                <label class="modern-date-label">Data Início</label>
                                <input type="date" id="inpDateStart" class="modern-date-input">
                            </div>
                            <div class="modern-date-wrapper" onclick="acionarCalendario(this)">
                                <label class="modern-date-label">Prazo Limite</label>
                                <input type="date" id="inpDateDue" class="modern-date-input">
                            </div>
                        </div>
                    </div>

                    <div class="clean-section">
                        <div class="section-header"><span style="display:flex;align-items:center;gap:6px;"><span class="material-icons-round" style="font-size:18px">attach_file</span> Anexos</span>
                        </div>
                        <div class="file-upload-area">
                            <span class="material-icons-round" style="font-size:24px; color:var(--text-light);">cloud_upload</span>
                            <div style="font-size:0.8rem; color:var(--text-light);">Adicionar Arquivos</div>
                            <input type="file" id="inpFiles" class="file-input-hidden" multiple accept="image/*,.pdf">
                            <div id="filePreviewList" style="margin-top:5px; display:flex; flex-wrap:wrap; justify-content:center;"></div>
                        </div>
                        <div id="existingAttachmentsArea"></div>
                    </div>

                    <div class="clean-section">
                        <div class="section-header"><span style="display:flex;align-items:center;gap:6px;"><span class="material-icons-round" style="font-size:18px">map</span> Observações e Mapa de Execução</span>
                        </div>

                        <textarea id="inpObs" class="std-input-base std-textarea" placeholder="Observações Gerais do Projeto..." style="min-height:60px; margin-bottom:15px;"></textarea>

                        <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="text" id="newStepTitle" class="std-input-base" placeholder="Título da Ação (Ex: Reunião)" style="font-weight:700; flex:1;">

                                <div class="modern-date-wrapper" style="flex: 0 0 140px; padding: 5px 10px;" onclick="acionarCalendario(this)">
                                    <label class="modern-date-label">Data</label>
                                    <input type="date" id="newStepDate" class="modern-date-input" style="font-size:0.85rem">
                                </div>
                            </div>
                            <textarea id="newStepDesc" class="std-input-base" placeholder="Descrição detalhada do que foi feito..." style="min-height:60px; resize:vertical;"></textarea>

                            <button id="btnAddStepBtn" onclick="adicionarPasso()" class="btn-add-history" style="margin-top:10px; padding:8px; font-size:0.8rem;">Adicionar ao Mapa</button>
                        </div>

                        <div class="map-timeline" id="timelineList"></div>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button onclick="tentarDeletar()" style="background:none; border:none; color:var(--danger); font-weight:700; cursor:pointer; display:flex; gap:5px; align-items:center; font-size:0.9rem;"><span class="material-icons-round">delete</span> Excluir</button>
                <div class="status-segmented">
                    <div class="seg-btn" data-val="pendente" onclick="setStatus(this)"><span class="material-icons-round" style="font-size:16px">radio_button_unchecked</span> A Fazer</div>
                    <div class="seg-btn" data-val="andamento" onclick="setStatus(this)"><span class="material-icons-round" style="font-size:16px">sync</span> Andamento</div>
                    <div class="seg-btn" data-val="concluido" onclick="setStatus(this)"><span class="material-icons-round" style="font-size:16px">check_circle</span> Concluído</div>
                </div>
                <input type="hidden" id="selectedStatus" value="pendente">
                <button class="btn-save" id="btnSalvarPrincipal" onclick="salvarTask()">Salvar Tudo</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalNomes" style="z-index: 200;">
        <div class="modal-wide" style="max-width: 500px; height: auto; max-height: 80vh;">
            <div class="modal-top">
                <h3 style="margin:0; font-family:'Montserrat',sans-serif; color:var(--primary);">Banco de Nomes</h3>
                <button class="close-btn" onclick="fecharModalNomes()"><span class="material-icons-round">close</span></button>
            </div>
            <div class="modal-body" style="display:block; padding:0;">
                <div id="namesListContainer" style="padding: 0; overflow-y: auto; max-height: 60vh;"></div>
            </div>
            <div style="padding:15px; text-align:center; font-size:0.8rem; color:var(--text-light); border-top:1px solid var(--border-light);">
                Clique em um nome para copiar.
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal" style="z-index:110">
        <div class="confirm-box">
            <div class="confirm-icon"><span class="material-icons-round" style="font-size:30px">delete_forever</span></div>
            <div class="confirm-title">Excluir Ocorrência?</div>
            <div class="confirm-desc">Atenção: Isso apagará o registro e moverá os anexos para a lixeira do Drive.</div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="fecharDeleteModal()">Cancelar</button>
                <button class="btn-delete" id="btnConfirmarExclusao" onclick="confirmarExclusao()">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="attachmentDeleteModal" style="z-index:115">
        <div class="confirm-box">
            <div class="alert-icon"><span class="material-icons-round" style="font-size:30px">priority_high</span></div>
            <div class="confirm-title">Remover Anexo?</div>
            <div class="confirm-desc">O arquivo será movido para a lixeira do Google Drive ao salvar.</div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="fecharModalAnexo()">Cancelar</button>
                <button class="btn-delete" onclick="confirmarExclusaoAnexo()">Remover</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="alertModal" style="z-index:120">
        <div class="confirm-box">
            <div class="alert-icon"><span class="material-icons-round" style="font-size:30px">priority_high</span></div>
            <div class="confirm-title">Atenção</div>
            <div class="confirm-desc" id="alertMsg">Preencha o título.</div>
            <div class="confirm-actions"><button class="btn-ok" onclick="fecharAlertModal()">Entendi</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="draftConfirmModal" style="z-index:125">
        <div class="confirm-box">
            <div class="alert-icon" style="color:var(--primary); background:var(--primary-soft);"><span class="material-icons-round" style="font-size:30px">save_as</span></div>
            <div class="confirm-title">Alterações não Salvas</div>
            <div class="confirm-desc">
                Há alterações não salvas. Deseja continuar editando ou descartar as alterações atuais?
                <div id="txtDraftName" style="margin-top:10px; padding:5px; background:#f1f5f9; border-radius:6px; font-weight:700; font-size:0.85rem; color:var(--primary); word-break: break-word;"></div>
            </div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="descartarRascunho()">Descartar Alterações</button>
                <button class="btn-ok" onclick="usarRascunho()">Continuar Editando</button>
            </div>
        </div>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyA8a8PaPz7T4lkx6NlQfeX1iWiNi9OywZKQO-Y_hUaNzrZF5_66ptDHCA-l9_IFeKc/exec";
    const API_TOKEN = "fav-2026-seguro-123";

    let tasks = [];
    let tempSteps = [];
    let newFiles = [];
    let keptExistingAttachments = [];
    let filesToDelete = [];
    let editingStepIndex = -1;
    let termoBusca = "";
    let isStatsOpen = false;
    let attachmentToDeleteIndex = -1;

    // --- SISTEMA DE PIN (LocalStorage) ---
    let pinnedItems = JSON.parse(localStorage.getItem('fav_pinned_tasks')) || [];

    // --- SISTEMA DE RASCUNHO ---
    let draftData = null;
    let estadoInicialFormulario = "";
    let pendingIntentId = null;

    // Cache e Controle
    let photoCache = {};
    let buscandoAgora = new Set();
    let dbNomes = {};
    let debounceTimer;
    let filterTimeout;

    Chart.defaults.font.family = 'Montserrat';
    Chart.defaults.color = '#64748b';
    let chartStatusInstance, chartRespInstance, chartUnitInstance, chartPrazosInstance;

    const grid = document.getElementById('grid');
    const modal = document.getElementById('modalOverlay');
    const deleteModal = document.getElementById('deleteModal');
    const attachmentDeleteModal = document.getElementById('attachmentDeleteModal');
    const alertModal = document.getElementById('alertModal');
    const draftConfirmModal = document.getElementById('draftConfirmModal');
    const timelineList = document.getElementById('timelineList');
    const btnAddStep = document.getElementById('btnAddStepBtn');
    const statsPanel = document.getElementById('statsPanel');
    const btnStats = document.getElementById('btnStats');
    const loadingOverlay = document.getElementById('loading-overlay');
    const fileInput = document.getElementById('inpFiles');

    // --- FUNÇÃO RESETAR PÁGINA ---
    function resetarPagina() {
        if (document.activeElement) document.activeElement.blur();
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        const searchInput = document.querySelector('.search-input');
        if (searchInput) searchInput.value = "";
        termoBusca = "";
        if (isStatsOpen) {
            statsPanel.classList.remove('open');
            document.getElementById('btnStats').classList.remove('active');
            isStatsOpen = false;
        }
        setTimeout(() => limparFiltros(false), 300);
    }

    // --- FUNÇÕES DE INTERFACE ---
    function toggleDropdown(id) {
        const el = document.getElementById(id);
        const overlay = document.getElementById('clickOverlay');
        document.querySelectorAll('.custom-dropdown').forEach(d => {
            if (d.id !== id) d.classList.remove('active');
        });
        if (el.classList.contains('active')) {
            el.classList.remove('active');
            overlay.classList.remove('active');
        } else {
            el.classList.add('active');
            overlay.classList.add('active');
        }
    }

    function toggleModalDropdown(id, e) {
        if (e) e.stopPropagation();
        const el = document.getElementById(id);
        document.querySelectorAll('.custom-dropdown-modal').forEach(d => {
            if (d.id !== id) d.classList.remove('active');
        });

        if (el.classList.contains('active')) {
            el.classList.remove('active');
        } else {
            el.classList.add('active');
            const inputVal = el.querySelector('input').value;
            el.querySelectorAll('.dropdown-item').forEach(item => {
                const dataVal = item.getAttribute('data-value');
                if (dataVal === inputVal) item.classList.add('selected');
                else item.classList.remove('selected');
            });
        }
    }

    function selectModalOption(type, value, label, e) {
        if (e) e.stopPropagation();
        if (type === 'unit') {
            document.getElementById('inpUnit').value = value;
            document.getElementById('display-unit').innerText = label;
            document.getElementById('dd-modal-unit').classList.remove('active');
        } else if (type === 'priority') {
            document.getElementById('inpPriority').value = value;
            document.getElementById('display-prio').innerText = label;
            document.getElementById('dd-modal-prio').classList.remove('active');
        }
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-dropdown-modal')) {
            document.querySelectorAll('.custom-dropdown-modal').forEach(d => d.classList.remove('active'));
        }
    });

    function closeAllDropdowns() {
        document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
        document.getElementById('clickOverlay').classList.remove('active');
    }

    function selectFilter(type, value, label, item) {
        document.getElementById('filtro-' + type).value = value;
        const btnLabel = document.getElementById('lbl-' + type);
        if (btnLabel) btnLabel.innerText = label;
        const container = document.getElementById('dd-' + type);
        const options = container.querySelectorAll('.dropdown-item');
        options.forEach(op => op.classList.remove('selected'));
        item.classList.add('selected');
        closeAllDropdowns();
        aplicarFiltros(true);
    }

    function formatarMoeda(elm) {
        let value = elm.value.replace(/\D/g, "");
        value = (Number(value) / 100).toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL"
        });
        elm.value = value;
    }

    function formatarData(isoStr) {
        if (!isoStr) return "";
        const partes = isoStr.split(/[-/T ]/);
        if (partes.length >= 3) {
            if (partes[0].length === 4) return `${partes[2]}/${partes[1]}/${partes[0]}`;
            return `${partes[0]}/${partes[1]}/${partes[2]}`;
        }
        return isoStr;
    }

    function dataParaInput(isoStr) {
        if (!isoStr) return "";
        const d = new Date(isoStr);
        if (isNaN(d.getTime())) return "";
        return d.toISOString().split('T')[0];
    }

    function formatarNomeProprio(texto) {
        if (!texto || typeof texto !== 'string') return "";
        return texto.trim().replace(/\s+/g, ' ').toLowerCase().replace(/(?:^|\s)\S/g, function(a) {
            return a.toUpperCase();
        });
    }

    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'check_circle' : (type === 'info' ? 'info' : 'error');
        toast.innerHTML = `<span class="material-icons-round" style="font-size:18px">${icon}</span> ${msg}`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('visible'));
        setTimeout(() => {
            toast.classList.remove('visible');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    function normalizarTexto(t) {
        if (!t) return "pendente";
        return t.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // --- ARQUIVOS ---
    fileInput.addEventListener('change', function(e) {
        if (this.files) {
            Array.from(this.files).forEach(f => {
                const r = new FileReader();
                r.onload = evt => {
                    newFiles.push({
                        name: f.name,
                        type: f.type,
                        data: evt.target.result
                    });
                    renderFilePreview();
                };
                r.readAsDataURL(f);
            });
        }
        this.value = '';
    });

    function renderFilePreview() {
        const c = document.getElementById('filePreviewList');
        c.innerHTML = "";
        newFiles.forEach((f, i) => {
            const s = document.createElement('span');
            s.className = 'file-chip';
            let th = f.data.startsWith('data:image') ? `<img src="${f.data}" class="file-preview-img">` : `<span class="material-icons-round" style="font-size:16px">insert_drive_file</span>`;
            s.innerHTML = `${th} <span class="file-name-trunc" title="${f.name}">${f.name}</span> <div class="file-remove-btn" onclick="removeNewFile(${i}, event)">&times;</div>`;
            c.appendChild(s);
        });
    }

    function removeNewFile(i, e) {
        if (e) e.stopPropagation();
        newFiles.splice(i, 1);
        renderFilePreview();
    }

    function removeExistingAttachment(idx) {
        attachmentToDeleteIndex = idx;
        attachmentDeleteModal.style.display = 'flex';
        setTimeout(() => attachmentDeleteModal.classList.add('active'), 10);
    }

    function fecharModalAnexo() {
        attachmentDeleteModal.classList.remove('active');
        setTimeout(() => attachmentDeleteModal.style.display = 'none', 300);
        attachmentToDeleteIndex = -1;
    }

    function confirmarExclusaoAnexo() {
        if (attachmentToDeleteIndex > -1) {
            filesToDelete.push(keptExistingAttachments[attachmentToDeleteIndex]);
            keptExistingAttachments.splice(attachmentToDeleteIndex, 1);
            renderExistingAttachments();
            fecharModalAnexo();
        }
    }

    function renderExistingAttachments() {
        const c = document.getElementById('existingAttachmentsArea');
        if (keptExistingAttachments.length === 0) {
            c.innerHTML = "";
            return;
        }
        let h = '<div style="margin-bottom:5px; font-weight:bold; font-size:0.8rem; color:#555">Arquivos Salvos:</div><div style="display:flex; flex-wrap:wrap;">';
        keptExistingAttachments.forEach((l, i) => {
            h += `<div class="existing-file-link"><span class="material-icons-round" style="font-size:16px; color:var(--primary)">cloud_done</span> <span onclick="window.open('${l}','_blank')">Ver Arquivo ${i + 1}</span><span class="material-icons-round" style="font-size:14px; color:var(--danger); cursor:pointer; margin-left:5px;" onclick="removeExistingAttachment(${i})">close</span></div>`;
        });
        h += '</div>';
        c.innerHTML = h;
    }

    // --- CARREGAMENTO DE DADOS ---
    carregarDados();

    async function carregarDados(silencioso = false) {
        try {
            if (!silencioso) loadingOverlay.classList.remove('hidden');

            const r = await fetch(`${API_URL}?action=read&token=${API_TOKEN}&v=${Date.now()}`);
            const d = await r.json();

            if (d.result === 'error') throw new Error(d.message);
            if (d.error) throw new Error(d.error);

            const lista = Array.isArray(d) ? d : [];

            tasks = lista.map(t => {
                const k = (n) => Object.keys(t).find(x => x.toLowerCase() === n.toLowerCase());
                let stepsRaw = t.steps;
                if (typeof stepsRaw === 'string') {
                    try {
                        stepsRaw = JSON.parse(stepsRaw);
                    } catch {
                        stepsRaw = [];
                    }
                }

                return {
                    ...t,
                    id: t.id,
                    title: t.title || "Sem Título",
                    dateStart: t[k('datestart')] || "",
                    dateDue: t[k('datedue')] || "",
                    status: t[k('status')] || "pendente",
                    steps: Array.isArray(stepsRaw) ? stepsRaw : [],
                    attachments: t[k('attachments')] || "",
                    origin: t[k('origin')] || "",
                    unit: t[k('unit')] || "",
                    resp: t[k('resp')] || "",
                    why: t[k('why')] || "",
                    how: t[k('how')] || "",
                    cost: t[k('cost')] || "",
                    obs: t[k('obs')] || ""
                };
            });

            checkPinnedExpiration();
            popularFiltroUnidades();
            popularFiltroOrigem();
            aplicarFiltros(!silencioso);

            // Gráficos podem esperar um pouco para não travar o carregamento inicial da UI
            if (isStatsOpen) setTimeout(() => atualizarGraficos(), 100);

            if (Object.keys(dbNomes).length === 0) {
                fetch(`${API_URL}?action=getNamesHistory&token=${API_TOKEN}`)
                    .then(res => res.json())
                    .then(data => {
                        dbNomes = data;
                    })
                    .catch(err => console.log("Erro nomes:", err));
            }

        } catch (e) {
            console.error("Erro ao carregar:", e);
            if (!silencioso) showToast("Erro ao conectar no banco", "error");
        } finally {
            if (!silencioso) loadingOverlay.classList.add('hidden');
        }
    }

    function popularFiltroUnidades() {
        const list = document.getElementById('list-unidade');
        const currentVal = document.getElementById('filtro-unidade').value;
        const u = [...new Set(tasks.map(t => t.unit).filter(x => x))].sort();
        let html = `<div class="dropdown-item ${currentVal === 'todos' ? 'selected' : ''}" onclick="selectFilter('unidade', 'todos', 'Unidade: Todas', this)">Unidade: Todas</div>`;
        u.forEach(x => {
            const isSel = currentVal === x ? 'selected' : '';
            html += `<div class="dropdown-item ${isSel}" onclick="selectFilter('unidade', '${x}', '${x}', this)">${x}</div>`;
        });
        list.innerHTML = html;
    }

    function popularFiltroOrigem() {
        const list = document.getElementById('list-origem');
        const currentVal = document.getElementById('filtro-origem').value;
        const o = [...new Set(tasks.map(t => t.origin).filter(x => x && x.trim() !== ''))].sort();
        let html = `<div class="dropdown-item ${currentVal === 'todos' ? 'selected' : ''}" onclick="selectFilter('origem', 'todos', 'Origem: Todas', this)">Origem: Todas</div>`;
        o.forEach(x => {
            const isSel = currentVal === x ? 'selected' : '';
            html += `<div class="dropdown-item ${isSel}" onclick="selectFilter('origem', '${x}', '${x}', this)">${x}</div>`;
        });
        list.innerHTML = html;
    }

    function filtrarCards(v) {
        termoBusca = v.toLowerCase();
        if (filterTimeout) clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            aplicarFiltros(true);
        }, 300);
    }

    function limparFiltros(animar = true) {
        document.getElementById('filtro-status').value = 'todos';
        document.getElementById('filtro-prioridade').value = 'todos';
        document.getElementById('filtro-unidade').value = 'todos';
        document.getElementById('filtro-origem').value = 'todos';
        document.getElementById('lbl-status').innerText = 'Status: Todos';
        document.getElementById('lbl-prioridade').innerText = 'Prioridade: Todas';
        document.getElementById('lbl-unidade').innerText = 'Unidade: Todas';
        document.getElementById('lbl-origem').innerText = 'Origem: Todas';
        document.querySelectorAll('.dropdown-item').forEach(d => d.classList.remove('selected'));
        document.querySelectorAll('.dropdown-options').forEach(optContainer => {
            if (optContainer.children[0]) optContainer.children[0].classList.add('selected');
        });

        termoBusca = "";
        const searchInput = document.querySelector('.search-input');
        if (searchInput) searchInput.value = "";
        aplicarFiltros(animar);
    }

    function aplicarFiltros(animar = true) {
        const fs = document.getElementById('filtro-status').value;
        const fp = document.getElementById('filtro-prioridade').value;
        const fu = document.getElementById('filtro-unidade').value;
        const fo = document.getElementById('filtro-origem').value;
        const btn = document.getElementById('btn-limpar');

        const deveMostrar = (fs !== 'todos' || fp !== 'todos' || fu !== 'todos' || fo !== 'todos' || termoBusca !== "");
        if (deveMostrar) btn.classList.add('visible');
        else btn.classList.remove('visible');

        // Filtro rápido em memória
        const f = tasks.filter(t => {
            const tTitle = (t.title || "").toLowerCase();
            const tResp = (t.resp || "").toLowerCase();
            const tUnit = (t.unit || "").toLowerCase();

            const mB = termoBusca === "" || tTitle.includes(termoBusca) || tResp.includes(termoBusca) || tUnit.includes(termoBusca);
            const mS = fs === 'todos' || normalizarTexto(t.status) === fs;
            const mP = fp === 'todos' || (t.priority || 'baixa') === fp;
            const mU = fu === 'todos' || t.unit === fu;
            const mO = fo === 'todos' || (t.origin && t.origin === fo);

            return mB && mS && mP && mU && mO;
        });

        const hj = new Date().toISOString().split('T')[0];
        f.sort((a, b) => {
            const stA = normalizarTexto(a.status),
                stB = normalizarTexto(b.status);
            const isConcA = (stA === 'concluido'),
                isConcB = (stB === 'concluido');
            if (isConcA && !isConcB) return 1;
            if (!isConcA && isConcB) return -1;
            const dDueA = dataParaInput(a.dateDue),
                dDueB = dataParaInput(b.dateDue);
            const isLateA = (dDueA && dDueA < hj && dDueA !== ""),
                isLateB = (dDueB && dDueB < hj && dDueB !== "");
            if (isLateA && !isLateB) return -1;
            if (!isLateA && isLateB) return 1;
            if (isLateA && isLateB) {
                if (dDueA < dDueB) return -1;
                if (dDueA > dDueB) return 1;
            }
            const mapPrio = {
                'alta': 3,
                'media': 2,
                'baixa': 1
            };
            const pA = mapPrio[a.priority || 'baixa'] || 1,
                pB = mapPrio[b.priority || 'baixa'] || 1;
            if (pA > pB) return -1;
            if (pA < pB) return 1;
            return b.id - a.id;
        });

        renderGrid(f, animar);
    }

    // --- RENDERIZAÇÃO INTELIGENTE ---
    async function buscarFoto(nome) {
        if (!nome) return null;
        if (photoCache[nome] !== undefined) return photoCache[nome];
        if (buscandoAgora.has(nome)) return null;
        buscandoAgora.add(nome);
        try {
            const res = await fetch(`${API_URL}?action=getPhoto&name=${encodeURIComponent(nome)}&token=${API_TOKEN}`);
            const data = await res.json();
            if (data.url) {
                photoCache[nome] = data.url;
                document.querySelectorAll(`.avatar-stack-item[data-name="${nome}"]`).forEach(el => {
                    el.innerHTML = `<img src="${data.url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    el.className = el.className.replace(/av-color-\d/g, "");
                    el.style.backgroundColor = "transparent";
                });
                document.querySelectorAll(`.avatar-wrapper[data-name="${nome}"]`).forEach(wrapper => {
                    const divBolinha = wrapper.querySelector('div.modal-avatar-big');
                    if (divBolinha) divBolinha.remove();
                    if (!wrapper.querySelector('img')) {
                        const img = document.createElement('img');
                        img.src = data.url;
                        img.className = 'modal-avatar-big';
                        wrapper.appendChild(img);
                    }
                });
                buscandoAgora.delete(nome);
                return data.url;
            } else {
                photoCache[nome] = null;
                buscandoAgora.delete(nome);
            }
        } catch (e) {
            photoCache[nome] = null;
            buscandoAgora.delete(nome);
        }
        return null;
    }

    function getAvatarHTML(nomeStr, index) {
        if (!nomeStr) return '';
        const nomeTrim = formatarNomeProprio(nomeStr.trim());
        if (!nomeTrim || !nomeTrim.includes(' ')) return '';
        const url = photoCache[nomeTrim];
        const colorIndex = nomeTrim.length % 6;
        const fallbackClass = `av-color-${colorIndex}`;
        const zIdx = 10 - index;
        if (url) return `<div class="avatar-stack-item" style="z-index:${zIdx}" title="${nomeTrim}" data-name="${nomeTrim}"><img src="${url}" alt="${nomeTrim[0]}" onerror="this.style.display='none';this.parentNode.classList.add('${fallbackClass}');this.parentNode.innerText='${nomeTrim[0]}' "></div>`;
        if (photoCache[nomeTrim] === undefined) buscarFoto(nomeTrim);
        return `<div class="avatar-stack-item ${fallbackClass}" style="z-index:${zIdx}" title="${nomeTrim}" data-name="${nomeTrim}">${nomeTrim[0].toUpperCase()}</div>`;
    }

    // --- LÓGICA DE PIN / FIXAR (OTIMIZADA - ZERO LAG & ANIMAÇÃO DE SAÍDA) ---
    function checkPinnedExpiration() {
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        const validPins = pinnedItems.filter(p => (now - p.time) < oneDay);
        if (validPins.length !== pinnedItems.length) {
            pinnedItems = validPins;
            localStorage.setItem('fav_pinned_tasks', JSON.stringify(pinnedItems));
        }
        renderPinnedSection();
    }

    function togglePin(id, e) {
        if (e) e.stopPropagation();
        const now = Date.now();
        const idx = pinnedItems.findIndex(p => String(p.id) === String(id));

        // Se já está pinado, vamos remover (com animação na barra superior)
        if (idx > -1) {
            // Acha o card na barra superior
            const pinnedCard = document.querySelector(`.pinned-card[onclick*="${id}"]`);
            if (pinnedCard) {
                pinnedCard.classList.add('animate-leave');
                // Espera a animação de 300ms terminar para atualizar os dados
                setTimeout(() => {
                    pinnedItems.splice(idx, 1);
                    localStorage.setItem('fav_pinned_tasks', JSON.stringify(pinnedItems));
                    renderPinnedSection();
                }, 280);
            } else {
                // Caso não ache o card (raro), remove direto
                pinnedItems.splice(idx, 1);
                localStorage.setItem('fav_pinned_tasks', JSON.stringify(pinnedItems));
                renderPinnedSection();
            }
        } else {
            // Adicionar (Animação de entrada já é feita pelo CSS 'animate-enter')
            pinnedItems.push({
                id: id,
                time: now
            });
            localStorage.setItem('fav_pinned_tasks', JSON.stringify(pinnedItems));
            renderPinnedSection();
        }

        // Atualiza visualmente o botão da grid IMEDIATAMENTE (sem recarregar a grid)
        const pinBtn = document.querySelector(`.card .btn-pin-card[onclick*="${id}"]`);
        if (pinBtn) {
            pinBtn.classList.toggle('active');
            const isPinnedNow = pinBtn.classList.contains('active');
            pinBtn.setAttribute('title', isPinnedNow ? 'Desafixar' : 'Fixar por 24h');
        }
    }

    function renderPinnedSection() {
        const container = document.getElementById('pinnedSection');
        const gridPin = document.getElementById('pinnedGrid');

        // Diff rápido
        const pinnedTasks = [];
        pinnedItems.forEach(p => {
            const t = tasks.find(x => String(x.id) === String(p.id));
            if (t) pinnedTasks.push(t);
        });

        if (pinnedTasks.length === 0) {
            container.classList.remove('visible');
            setTimeout(() => {
                if (!container.classList.contains('visible')) container.style.display = 'none';
            }, 300);
            return;
        }

        container.style.display = 'flex';
        requestAnimationFrame(() => container.classList.add('visible'));

        // Limpa e recria (simples e seguro para poucos itens)
        gridPin.innerHTML = "";

        pinnedTasks.forEach(t => {
            const card = document.createElement('div');
            // 'animate-enter' garante a suavidade ao surgir
            card.className = 'pinned-card animate-enter';
            // Importante: Passar o ID corretamente para o onclick
            card.setAttribute('onclick', `abrirModal('${t.id}', event)`);

            const st = normalizarTexto(t.status);
            const corStatus = st === 'concluido' ? 'var(--status-done)' : (st === 'andamento' ? 'var(--warning)' : 'var(--text-light)');

            card.innerHTML = `
                    <div style="font-size:0.65rem; font-weight:800; color:${corStatus}; text-transform:uppercase; margin-bottom:5px;">
                        ${t.status || 'Pendente'}
                    </div>
                    <div style="font-weight:700; font-size:0.85rem; color:var(--text-main); margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:20px;">
                        ${t.title}
                    </div>
                    <div style="font-size:0.75rem; color:var(--text-light);">
                        ${t.unit || 'N/A'}
                    </div>
                    <div class="btn-pin-card active" onclick="togglePin('${t.id}', event)" title="Desafixar">
                        <span class="material-icons-round" style="font-size:16px">push_pin</span>
                    </div>
                `;
            gridPin.appendChild(card);
        });
    }

    function renderGrid(l, animar = true) {
        grid.innerHTML = "";
        if (l.length === 0) {
            grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;text-align:center;padding:80px;color:#94a3b8"><span class="material-icons-round" style="font-size:40px">filter_list_off</span><h3>Nada encontrado</h3></div>`;
            return;
        }
        const hj = new Date().toISOString().split('T')[0];

        const fragment = document.createDocumentFragment();

        l.forEach((t, i) => {
            const st = normalizarTexto(t.status);
            const dDue = dataParaInput(t.dateDue);
            const isLate = (dDue && dDue < hj && st !== 'concluido');
            const isConc = (st === 'concluido');
            const isOnt = (dDue && !isLate && !isConc);

            const respH = t.resp ? t.resp.split(',').map((r, idx) => getAvatarHTML(r, idx)).join('') : '<span style="font-size:0.7rem;color:#94a3b8; padding-left:10px;">--</span>';
            const stInfo = st === 'pendente' ? {
                l: 'A Fazer',
                c: 'st-pendente'
            } : st === 'andamento' ? {
                l: 'Andamento',
                c: 'st-andamento'
            } : {
                l: 'Concluído',
                c: 'st-concluido'
            };
            const corBarra = st === 'pendente' ? 'rgba(0,0,0,0.05)' : st === 'andamento' ? '#f59e0b' : '#059669';
            const prio = t.priority || 'baixa';
            const pL = {
                'alta': 'Alta',
                'media': 'Média',
                'baixa': 'Baixa'
            } [prio] || 'Baixa';
            const pC = {
                'alta': 'p-alta',
                'media': 'p-media',
                'baixa': 'p-baixa'
            } [prio] || 'p-baixa';
            const pI = prio === 'alta' ? 'priority_high' : prio === 'media' ? 'remove' : 'keyboard_arrow_down';

            let dtH = isLate ? `<span class="date-pill late">Atrasado</span>` : isOnt ? `<span class="date-pill ontime">Em dia</span>` : (!dDue && !isConc) ? `<span class="date-pill nodate">S/ Prazo</span>` : '';

            let thH = '';
            if (t.attachments) {
                let lks = t.attachments.toString().includes("|||") ? t.attachments.split('|||').filter(x => x) : t.attachments.split(',').filter(x => x);
                if (lks.length > 0) {
                    let innerTh = '';
                    for (let j = 0; j < Math.min(lks.length, 3); j++) innerTh += `<a href="${lks[j]}" target="_blank" class="thumb-link" onclick="event.stopPropagation()"><span class="material-icons-round" style="font-size:16px">description</span></a>`;
                    if (lks.length > 3) innerTh += `<div class="thumb-more">+${lks.length - 3}</div>`;
                    thH = `<div class="card-thumbs">${innerTh}</div>`;
                }
            }
            if (!thH) thH = `<div class="card-thumbs"></div>`;

            const isPinned = pinnedItems.some(p => String(p.id) === String(t.id));
            const pinClass = isPinned ? 'active' : '';

            const c = document.createElement('div');
            c.className = `card ${animar ? 'animate-in' : 'no-anim'} ${isLate ? 'is-late' : ''} ${isConc ? 'is-concluded' : ''}`;
            c.onclick = () => abrirModal(t.id, event);
            if (animar) c.style.animationDelay = `${i * 0.05}s`;

            c.innerHTML = `
                    <div class="card-main">
                        <div class="btn-pin-card ${pinClass}" onclick="togglePin('${t.id}', event)" title="${isPinned ? 'Desafixar' : 'Fixar por 24h'}">
                            <span class="material-icons-round" style="font-size:16px">push_pin</span>
                        </div>
                        <div class="card-header-top">
                            <div class="prio-badge ${pC}"><span class="material-icons-round" style="font-size:10px">${pI}</span> ${pL}</div>
                            <div class="status-text ${stInfo.c}"><div class="dot-status"></div> ${stInfo.l}</div>
                        </div>
                        <h3 title="${t.title}">${t.title}</h3>
                        <div class="card-origin-row"><span class="material-icons-round card-icon-std">history_edu</span> ${t.origin || 'N/A'}</div>
                        ${thH}
                        <div class="card-meta">
                            <div class="meta-item"><span class="material-icons-round card-icon-std">event</span> ${formatarData(t.dateStart)}</div>
                            <div class="meta-item"><span class="material-icons-round" style="font-size:16px;color:${isLate ? 'var(--danger)' : 'inherit'}">event_busy</span> ${formatarData(t.dateDue)} ${dtH}</div>
                        </div>
                    </div>
                    <div class="card-footer"><div class="resp-container">${respH}</div><div class="unit-clean"><span class="material-icons-round card-icon-std">apartment</span> ${t.unit || 'N/A'}</div></div>
                    <div class="card-progress-bar"><div class="progress-fill" style="width:100%;background:${corBarra}"></div></div>`;

            fragment.appendChild(c);
        });

        grid.appendChild(fragment);
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    // --- MODAL, NOMES E RASCUNHOS ---
    function abrirModalNomes(e = null) {
        if (e) e.stopPropagation();
        const container = document.getElementById('namesListContainer');
        container.innerHTML = '';
        let lista = [];
        for (let k in dbNomes) {
            dbNomes[k].forEach(last => lista.push(k + " " + last));
        }
        lista.sort();
        if (lista.length === 0) container.innerHTML = '<div style="padding:20px;text-align:center;color:#aaa;">Nenhum nome encontrado.</div>';
        else {
            lista.forEach(n => {
                const item = document.createElement('div');
                item.className = 'name-list-item';
                item.innerHTML = `<span>${n}</span> <span class="material-icons-round" style="font-size:18px; color:var(--brand-cyan)">add_circle_outline</span>`;
                item.onclick = () => {
                    const input = document.getElementById('inpResp');
                    let valorAtual = input.value ? input.value.trimEnd() : "";
                    input.value = valorAtual.length > 0 ? (valorAtual.endsWith(',') ? valorAtual + " " + n : valorAtual + ", " + n) : n;
                    autoResize(input);
                    gerenciarInputResponsavel(input);
                    showToast(n + " adicionado!", "success");
                };
                container.appendChild(item);
            });
        }
        document.getElementById('modalNomes').style.display = 'flex';
        setTimeout(() => document.getElementById('modalNomes').classList.add('active'), 10);
    }

    function fecharModalNomes() {
        document.getElementById('modalNomes').classList.remove('active');
        setTimeout(() => document.getElementById('modalNomes').style.display = 'none', 300);
    }

    function gerenciarInputResponsavel(input) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => atualizarAvatarsModal(input.value), 1500);
    }

    async function atualizarAvatarsModal(valorInput) {
        const container = document.getElementById('modalAvatarList');
        if (!valorInput) {
            container.innerHTML = '';
            return;
        }
        const nomesFormatados = valorInput.split(/[\n,]/).filter(n => n.trim().length > 0).map(n => formatarNomeProprio(n.trim()));

        Array.from(container.children).forEach(el => {
            const nomeEl = el.querySelector('.avatar-wrapper') ? el.querySelector('.avatar-wrapper').dataset.name : el.getAttribute('data-name');
            if (!nomesFormatados.includes(nomeEl)) el.remove();
        });

        for (const n of nomesFormatados) {
            if (!n.includes(' ')) continue;
            const jaExiste = Array.from(container.children).some(el => {
                const nomeEl = el.querySelector('.avatar-wrapper') ? el.querySelector('.avatar-wrapper').dataset.name : el.getAttribute('data-name');
                return nomeEl === n;
            });
            if (!jaExiste) {
                const wrapper = document.createElement('div');
                wrapper.className = 'avatar-wrapper animate-in';
                wrapper.setAttribute('data-name', n);
                const div = document.createElement('div');
                div.className = `modal-avatar-big av-color-${n.length % 6}`;
                div.innerText = n[0].toUpperCase();
                wrapper.appendChild(div);
                container.appendChild(wrapper);
                buscarFoto(n).then(url => {
                    if (url) {
                        div.remove();
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'modal-avatar-big';
                        wrapper.appendChild(img);
                    }
                });
            }
        }
    }

    function capturarEstadoAtual() {
        return JSON.stringify({
            title: document.getElementById('inpTitle').value,
            origin: document.getElementById('inpOrigin').value,
            unit: document.getElementById('inpUnit').value,
            priority: document.getElementById('inpPriority').value,
            desc: document.getElementById('inpProblem').value,
            why: document.getElementById('inpWhy').value,
            how: document.getElementById('inpHow').value,
            cost: document.getElementById('inpCost').value,
            obs: document.getElementById('inpObs').value,
            resp: document.getElementById('inpResp').value,
            start: document.getElementById('inpDateStart').value,
            due: document.getElementById('inpDateDue').value,
            status: document.getElementById('selectedStatus').value,
            steps: tempSteps,
            newStepT: document.getElementById('newStepTitle').value,
            newStepD: document.getElementById('newStepDesc').value,
            newStepDt: document.getElementById('newStepDate').value,
            newFilesLen: newFiles.length,
            deletedFilesLen: filesToDelete.length
        });
    }

    function destacarCamposModificados(estadoDraft, estadoOriginal) {
        document.querySelectorAll('.modified-field').forEach(el => el.classList.remove('modified-field'));
        const draft = JSON.parse(estadoDraft);
        const orig = JSON.parse(estadoOriginal);
        const mapCampos = {
            'title': 'inpTitle',
            'origin': 'inpOrigin',
            'desc': 'inpProblem',
            'why': 'inpWhy',
            'how': 'inpHow',
            'cost': 'inpCost',
            'obs': 'inpObs',
            'resp': 'inpResp'
        };
        for (const key in mapCampos) {
            if (draft[key] !== orig[key]) {
                const el = document.getElementById(mapCampos[key]);
                if (el) el.classList.add('modified-field');
            }
        }
    }

    function fecharModal(isSaving = false) {
        const m = document.getElementById('modalOverlay');
        if (!isSaving) {
            const id = document.getElementById('taskId').value;
            const title = document.getElementById('inpTitle').value;
            const desc = document.getElementById('inpProblem').value;
            const estadoAtual = capturarEstadoAtual();
            if (estadoAtual !== estadoInicialFormulario && (title || desc)) {
                draftData = {
                    id: id,
                    title: title,
                    origin: document.getElementById('inpOrigin').value,
                    unit: document.getElementById('inpUnit').value,
                    priority: document.getElementById('inpPriority').value,
                    problem: desc,
                    why: document.getElementById('inpWhy').value,
                    how: document.getElementById('inpHow').value,
                    cost: document.getElementById('inpCost').value,
                    obs: document.getElementById('inpObs').value,
                    resp: document.getElementById('inpResp').value,
                    dateStart: document.getElementById('inpDateStart').value,
                    dateDue: document.getElementById('inpDateDue').value,
                    status: document.getElementById('selectedStatus').value,
                    steps: tempSteps,
                    newStepT: document.getElementById('newStepTitle').value,
                    newStepD: document.getElementById('newStepDesc').value,
                    newStepDt: document.getElementById('newStepDate').value,
                    newFiles: newFiles,
                    originalState: estadoInicialFormulario
                };
                showToast("Rascunho salvo temporariamente", "info");
            } else {
                if (draftData && draftData.id === id) draftData = null;
            }
        } else {
            draftData = null;
        }
        m.classList.remove('active');
        document.body.classList.remove('modal-open');
        setTimeout(() => {
            m.style.display = 'none';
            document.querySelectorAll('.modified-field').forEach(el => el.classList.remove('modified-field'));
        }, 300);
    }

    function abrirModal(id = null, e = null) {
        if (e) e.stopPropagation();
        pendingIntentId = id;
        if (draftData !== null) {
            if (id !== null && String(draftData.id) === String(id)) {
                prepararModal(id, true);
                return;
            }
            const draftTitle = draftData.title || "(Sem Título)";
            const draftType = draftData.id ? "Editando: " : "Novo: ";
            document.getElementById('txtDraftName').innerText = draftType + draftTitle;
            draftConfirmModal.style.display = 'flex';
            setTimeout(() => draftConfirmModal.classList.add('active'), 10);
            return;
        }
        prepararModal(id);
    }

    function descartarRascunho() {
        draftData = null;
        draftConfirmModal.classList.remove('active');
        setTimeout(() => {
            draftConfirmModal.style.display = 'none';
            prepararModal(pendingIntentId);
        }, 300);
    }

    function usarRascunho() {
        draftConfirmModal.classList.remove('active');
        setTimeout(() => {
            draftConfirmModal.style.display = 'none';
            prepararModal(draftData.id || null, true);
        }, 300);
    }

    function prepararModal(id, useDraft = false) {
        const m = document.getElementById('modalOverlay');
        m.style.display = 'flex';
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                m.classList.add('active');
                const body = document.querySelector('.modal-body-dashboard');
                if (body) body.scrollTop = 0;
            });
        });

        const isEdit = id !== null && id !== "";
        editingStepIndex = -1;
        document.getElementById('newStepDesc').value = '';
        document.getElementById('newStepDate').value = '';
        document.getElementById('newStepTitle').value = '';
        filesToDelete = [];
        keptExistingAttachments = [];
        document.getElementById('existingAttachmentsArea').innerHTML = '';
        const ti = document.getElementById('inpTitle');
        document.getElementById('modalAvatarList').innerHTML = "";

        let source = useDraft ? draftData : (isEdit ? tasks.find(x => String(x.id) === String(id)) : null);

        if (source) {
            document.getElementById('taskId').value = source.id || (useDraft ? '' : source.id);
            ti.value = source.title;
            setTimeout(() => autoResize(ti), 10);
            document.getElementById('inpUnit').value = source.unit;
            document.getElementById('display-unit').innerText = source.unit || 'Selecionar...';
            document.getElementById('inpPriority').value = source.priority;
            document.getElementById('display-prio').innerText = (source.priority === 'alta' ? 'Alta' : source.priority === 'media' ? 'Média' : 'Baixa');
            document.getElementById('inpOrigin').value = source.origin;
            document.getElementById('inpProblem').value = source.problem || source.desc || "";
            document.getElementById('inpWhy').value = source.why || "";
            document.getElementById('inpHow').value = source.how || "";
            document.getElementById('inpCost').value = source.cost || "";
            document.getElementById('inpObs').value = source.obs || "";
            document.getElementById('inpResp').value = source.resp;
            setTimeout(() => autoResize(document.getElementById('inpResp')), 10);
            if (source.resp) atualizarAvatarsModal(source.resp);
            document.getElementById('inpDateStart').value = useDraft ? source.dateStart : dataParaInput(source.dateStart);
            document.getElementById('inpDateDue').value = useDraft ? source.dateDue : dataParaInput(source.dateDue);
            updateStatusUI(useDraft ? source.status : normalizarTexto(source.status));
            tempSteps = source.steps ? [...source.steps] : [];

            if (useDraft) {
                newFiles = source.newFiles ? [...source.newFiles] : [];
                document.getElementById('newStepTitle').value = source.newStepT || '';
                document.getElementById('newStepDesc').value = source.newStepD || '';
                document.getElementById('newStepDate').value = source.newStepDt || '';
                if (source.id) {
                    const original = tasks.find(x => String(x.id) === String(source.id));
                    if (original && original.attachments) {
                        keptExistingAttachments = original.attachments.toString().includes("|||") ? original.attachments.split('|||').filter(x => x) : original.attachments.split(',').filter(x => x);
                        renderExistingAttachments();
                    }
                }
            } else {
                newFiles = [];
                if (source.attachments) {
                    keptExistingAttachments = source.attachments.toString().includes("|||") ? source.attachments.split('|||').filter(x => x) : source.attachments.split(',').filter(x => x);
                    renderExistingAttachments();
                }
            }

            renderFilePreview();
            if (useDraft && source.originalState) {
                setTimeout(() => destacarCamposModificados(capturarEstadoAtual(), source.originalState), 100);
            }
        } else {
            // Modo NOVO
            document.getElementById('taskId').value = '';
            ti.value = '';
            ti.style.height = '50px';
            document.getElementById('inpUnit').value = '';
            document.getElementById('display-unit').innerText = 'Selecionar...';
            document.getElementById('inpPriority').value = 'baixa';
            document.getElementById('display-prio').innerText = 'Baixa';
            document.getElementById('inpOrigin').value = '';
            document.getElementById('inpProblem').value = '';
            document.getElementById('inpWhy').value = '';
            document.getElementById('inpHow').value = '';
            document.getElementById('inpCost').value = '';
            document.getElementById('inpObs').value = '';
            const hj = new Date(),
                y = hj.getFullYear(),
                m = String(hj.getMonth() + 1).padStart(2, '0'),
                d = String(hj.getDate()).padStart(2, '0');
            document.getElementById('inpDateStart').value = `${y}-${m}-${d}`;
            document.getElementById('inpDateDue').value = '';
            updateStatusUI('pendente');
            document.getElementById('inpResp').value = '';
            document.getElementById('inpResp').style.height = '46px';
            tempSteps = [];
            newFiles = [];
            renderFilePreview();
        }

        renderTimeline();
        setTimeout(() => {
            estadoInicialFormulario = (useDraft && draftData && draftData.originalState) ? draftData.originalState : capturarEstadoAtual();
        }, 50);
        document.body.classList.add('modal-open');
    }

    // --- SALVAR OTIMISTA (BACKGROUND) ---
    function salvarTask() {
        const originVal = document.getElementById('inpOrigin').value;
        if (!originVal || originVal.trim() === "") {
            document.getElementById('alertMsg').innerText = "O campo ORIGEM é obrigatório!";
            document.getElementById('alertModal').style.display = 'flex';
            setTimeout(() => document.getElementById('alertModal').classList.add('active'), 10);
            return;
        }
        const id = document.getElementById('taskId').value;
        const title = document.getElementById('inpTitle').value;
        if (!title || title.trim() === "") {
            document.getElementById('alertMsg').innerText = "Preencha o título.";
            document.getElementById('alertModal').style.display = 'flex';
            setTimeout(() => document.getElementById('alertModal').classList.add('active'), 10);
            return;
        }

        // AUTO-SAVE DE PASSO
        const stT = document.getElementById('newStepTitle').value.trim();
        const stD = document.getElementById('newStepDesc').value.trim();
        if (stT !== "" || stD !== "") {
            const passo = {
                title: stT,
                desc: stD,
                date: document.getElementById('newStepDate').value
            };
            if (editingStepIndex > -1) tempSteps[editingStepIndex] = passo;
            else tempSteps.push(passo);
        }

        const taskObj = {
            id: id ? id : "temp_" + Date.now(),
            title: title,
            origin: originVal,
            unit: document.getElementById('inpUnit').value,
            priority: document.getElementById('inpPriority').value,
            status: document.getElementById('selectedStatus').value,
            resp: document.getElementById('inpResp').value,
            problem: document.getElementById('inpProblem').value,
            why: document.getElementById('inpWhy').value,
            how: document.getElementById('inpHow').value,
            cost: document.getElementById('inpCost').value,
            obs: document.getElementById('inpObs').value,
            dateStart: document.getElementById('inpDateStart').value,
            dateDue: document.getElementById('inpDateDue').value,
            steps: tempSteps,
            attachments: keptExistingAttachments.join('|||')
        };

        // Atualiza memória local imediatamente
        if (id) {
            const idx = tasks.findIndex(t => String(t.id) === String(id));
            if (idx > -1) tasks[idx] = { ...tasks[idx],
                ...taskObj
            };
        } else {
            tasks.unshift(taskObj);
        }

        // UI: Feedback Imediato
        fecharModal(true);
        showToast("Salvo com sucesso!", "success");

        // Renderização Rápida (Síncrona mas leve)
        aplicarFiltros(false); // Grid Principal sem animação pesada
        renderPinnedSection(); // Pinned (caso título/status tenha mudado)

        // BACKGROUND: Fetch e Gráficos Pesados (Deferral)
        setTimeout(() => {
            if (isStatsOpen) atualizarGraficos();

            const payload = {
                action: id ? 'update' : 'create',
                id: id,
                title: title,
                token: API_TOKEN,
                origin: originVal,
                unit: taskObj.unit,
                priority: taskObj.priority,
                status: taskObj.status,
                resp: taskObj.resp,
                problem: taskObj.problem,
                why: taskObj.why,
                how: taskObj.how,
                cost: taskObj.cost,
                obs: taskObj.obs,
                dateStart: taskObj.dateStart,
                dateDue: taskObj.dateDue,
                steps: JSON.stringify(tempSteps),
                keptAttachments: keptExistingAttachments.join('|||'),
                filesToDelete: filesToDelete.join('|||'),
                newFiles: newFiles
            };

            fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
                .then(d => {
                    if (d.result === 'success' || d.result === 'updated' || d.result === 'created') {
                        // Sync silencioso
                        carregarDados(true);
                    } else {
                        showToast("Erro no servidor: " + (d.message || d.error), "error");
                    }
                })
                .catch(e => console.log("Erro rede ao salvar", e));
        }, 100); // Delay mínimo para liberar a thread de UI
    }

    function tentarDeletar() {
        const id = document.getElementById('taskId').value;
        if (!id) return;
        document.getElementById('deleteModal').style.display = 'flex';
        setTimeout(() => document.getElementById('deleteModal').classList.add('active'), 10);
    }

    function fecharDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        setTimeout(() => document.getElementById('deleteModal').style.display = 'none', 300);
    }

    function confirmarExclusao() {
        const id = document.getElementById('taskId').value;
        if (!id) return;
        fecharDeleteModal();
        fecharModal(true);

        tasks = tasks.filter(t => String(t.id) !== String(id));
        const pinIdx = pinnedItems.findIndex(p => String(p.id) === String(id));
        if (pinIdx > -1) {
            pinnedItems.splice(pinIdx, 1);
            localStorage.setItem('fav_pinned_tasks', JSON.stringify(pinnedItems));
            renderPinnedSection();
        }
        aplicarFiltros(false);
        showToast("Excluído com sucesso!", "success");

        // Background Delete
        setTimeout(() => {
            fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "delete",
                        id: id,
                        token: API_TOKEN
                    })
                })
                .then(r => r.json())
                .catch(e => carregarDados(true));
        }, 50);
    }

    function fecharAlertModal() {
        document.getElementById('alertModal').classList.remove('active');
        setTimeout(() => document.getElementById('alertModal').style.display = 'none', 300);
    }

    function acionarCalendario(wrapper) {
        const input = wrapper.querySelector('input');
        if (input) {
            if (input.showPicker) input.showPicker();
            else {
                input.focus();
                input.click();
            }
        }
    }

    function renderTimeline(novoItemIndex = -1) {
        timelineList.innerHTML = "";
        tempSteps.forEach((s, i) => {
            const el = document.createElement('div');
            el.className = 'map-item';
            if (i === novoItemIndex) el.classList.add('new-item');
            el.innerHTML = `
                    <div class="map-connector"></div><div class="map-dot"></div>
                    <div class="map-card" onclick="toggleMapCard(this)">
                        <div class="map-card-header">
                            <div class="map-header-left"><span class="map-title">${s.title || "Sem Título"}</span><span class="map-date">${s.date ? formatarData(s.date) : "Data N/A"}</span></div>
                            <div class="map-header-right" onclick="event.stopPropagation()">
                                <span class="material-icons-round map-btn-icon" onclick="prepararEdicao(${i}, event)" title="Editar">edit</span>
                                <span class="material-icons-round map-btn-icon del" onclick="removeStep(${i}, event)" title="Excluir">delete</span>
                                <span class="material-icons-round toggle-icon" onclick="toggleMapCard(this.closest('.map-card'))">expand_more</span>
                            </div>
                        </div>
                        <div class="map-card-body"><div class="map-card-content-inner"><div class="map-desc">${s.desc || '<span style="color:#ccc;font-style:italic;">Sem descrição detalhada.</span>'}</div></div></div>
                    </div>`;
            timelineList.appendChild(el);
        });
        if (novoItemIndex > -1) setTimeout(() => timelineList.lastElementChild.scrollIntoView({
            behavior: 'smooth'
        }), 100);
    }

    function toggleMapCard(card) {
        if (card.classList.contains('open')) card.classList.remove('open');
        else card.classList.add('open');
    }

    function prepararEdicao(i, e) {
        if (e) e.stopPropagation();
        const s = tempSteps[i];
        document.getElementById('newStepTitle').value = s.title || "";
        document.getElementById('newStepDesc').value = s.desc || "";
        document.getElementById('newStepDate').value = s.date ? dataParaInput(s.date) : '';
        editingStepIndex = i;
        btnAddStep.innerText = "Salvar Alteração";
        document.getElementById('newStepTitle').focus();
        document.getElementById('newStepTitle').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }

    function adicionarPasso() {
        const t = document.getElementById('newStepTitle').value;
        const d = document.getElementById('newStepDesc').value;
        const dt = document.getElementById('newStepDate').value;
        if (!t && !d) return document.getElementById('newStepTitle').focus();
        const passoObj = {
            title: t,
            desc: d,
            date: dt
        };
        let novoIndex = -1;
        if (editingStepIndex > -1) {
            tempSteps[editingStepIndex] = passoObj;
            editingStepIndex = -1;
            btnAddStep.innerText = "Adicionar ao Mapa";
        } else {
            tempSteps.push(passoObj);
            novoIndex = tempSteps.length - 1;
        }
        renderTimeline(novoIndex);
        document.getElementById('newStepTitle').value = '';
        document.getElementById('newStepDesc').value = '';
        document.getElementById('newStepDate').value = '';
    }

    function removeStep(i, e) {
        if (e) e.stopPropagation();
        const el = timelineList.children[i];
        if (el) {
            el.classList.add('removing');
            setTimeout(() => {
                tempSteps.splice(i, 1);
                renderTimeline();
            }, 450);
        } else {
            tempSteps.splice(i, 1);
            renderTimeline();
        }
    }

    function setStatus(e) {
        updateStatusUI(e.getAttribute('data-val'));
    }

    function updateStatusUI(v) {
        document.getElementById('selectedStatus').value = v;
        document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.seg-btn[data-val="${v}"]`).classList.add('active');
    }

    modal.onclick = (e) => {
        if (e.target === modal) fecharModal()
    };
    deleteModal.onclick = (e) => {
        if (e.target === deleteModal) fecharDeleteModal()
    };
    attachmentDeleteModal.onclick = (e) => {
        if (e.target === attachmentDeleteModal) fecharModalAnexo()
    };
    alertModal.onclick = (e) => {
        if (e.target === alertModal) fecharAlertModal()
    };
    modalNomes.onclick = (e) => {
        if (e.target === modalNomes) fecharModalNomes()
    };
    draftConfirmModal.onclick = (e) => {
        if (e.target === draftConfirmModal) descartarRascunho()
    };

    function toggleStats(e) {
        isStatsOpen = !isStatsOpen;
        const btn = document.getElementById('btnStats');
        if (isStatsOpen) {
            statsPanel.classList.add('open');
            btn.classList.add('active');
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            // Delay para não travar a animação de abertura do painel
            if (tasks.length > 0) setTimeout(() => atualizarGraficos(), 300);
        } else {
            statsPanel.classList.remove('open');
            btn.classList.remove('active');
        }
    }

    function atualizarGraficos() {
        if (!isStatsOpen) return;
        if (chartStatusInstance) chartStatusInstance.destroy();
        if (chartPrazosInstance) chartPrazosInstance.destroy();
        if (chartUnitInstance) chartUnitInstance.destroy();
        if (chartRespInstance) chartRespInstance.destroy();

        const statsStatus = {
            pendente: 0,
            andamento: 0,
            concluido: 0
        };
        tasks.forEach(t => {
            let s = normalizarTexto(t.status);
            if (statsStatus[s] !== undefined) statsStatus[s]++;
            else statsStatus.pendente++;
        });

        const hj = new Date().toISOString().split('T')[0];
        let atrasados = 0,
            noPrazo = 0,
            semPrazo = 0;
        tasks.forEach(t => {
            if (normalizarTexto(t.status) === 'concluido') return;
            const d = dataParaInput(t.dateDue);
            if (!d) semPrazo++;
            else if (d < hj) atrasados++;
            else noPrazo++;
        });

        const unitMap = {},
            respMap = {};
        tasks.forEach(t => {
            const u = t.unit || 'Sem Unidade';
            unitMap[u] = (unitMap[u] || 0) + 1;
            if (t.resp) t.resp.split(',').forEach(r => {
                const name = formatarNomeProprio(r.trim());
                if (name) respMap[name] = (respMap[name] || 0) + 1;
            });
        });
        const sortedResp = Object.entries(respMap).sort((a, b) => b[1] - a[1]).slice(0, 5);

        const ctxStatus = document.getElementById('chartStatus').getContext('2d');
        chartStatusInstance = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['A Fazer', 'Andamento', 'Concluído'],
                datasets: [{
                    data: [statsStatus.pendente, statsStatus.andamento, statsStatus.concluido],
                    backgroundColor: ['#cbd5e1', '#f59e0b', '#059669'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 10
                        }
                    }
                }
            }
        });
        const ctxPrazos = document.getElementById('chartPrazos').getContext('2d');
        chartPrazosInstance = new Chart(ctxPrazos, {
            type: 'doughnut',
            data: {
                labels: ['Em Dia', 'Atrasado', 'S/ Prazo'],
                datasets: [{
                    data: [noPrazo, atrasados, semPrazo],
                    backgroundColor: ['#10b981', '#ef4444', '#e2e8f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 10
                        }
                    }
                }
            }
        });
        const ctxUnit = document.getElementById('chartUnit').getContext('2d');
        chartUnitInstance = new Chart(ctxUnit, {
            type: 'doughnut',
            data: {
                labels: Object.keys(unitMap),
                datasets: [{
                    label: 'Ocorrências',
                    data: Object.values(unitMap),
                    backgroundColor: ['#0f4c81', '#00d2d3', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 10
                        }
                    }
                }
            }
        });
        const containerResp = document.getElementById('respChartContainer');
        containerResp.style.height = (sortedResp.length * 40 + 50) + 'px';
        const ctxResp = document.getElementById('chartResp').getContext('2d');
        chartRespInstance = new Chart(ctxResp, {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: sortedResp.map(i => i[0]),
                datasets: [{
                    label: 'Tarefas Ativas',
                    data: sortedResp.map(i => i[1]),
                    backgroundColor: '#00d2d3',
                    borderRadius: 4,
                    barPercentage: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        padding: {
                            left: 35
                        }
                    }
                }
            }
        });
    }
</script>
</body>

</html>